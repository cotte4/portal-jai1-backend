generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                  String          @id @default(uuid()) @db.Uuid
  email               String          @unique
  passwordHash        String          @map("password_hash")
  role                UserRole        @default(client)
  firstName           String          @map("first_name")
  lastName            String          @map("last_name")
  phone               String?
  googleId            String?         @unique @map("google_id")
  isActive            Boolean         @default(true) @map("is_active")
  lastLoginAt         DateTime?       @map("last_login_at")
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")
  resetToken          String?         @map("reset_token")
  resetTokenExpiresAt DateTime?       @map("reset_token_expires_at")
  clientProfile       ClientProfile?
  notifications       Notification[]
  statusChanges       StatusHistory[] @relation("ChangedBy")
  ticketMessages      TicketMessage[]
  tickets             Ticket[]
  w2Estimates         W2Estimate[]

  @@map("users")
}

model ClientProfile {
  id                String    @id @default(uuid()) @db.Uuid
  userId            String    @unique @map("user_id") @db.Uuid
  ssn               String?
  dateOfBirth       DateTime? @map("date_of_birth")
  addressStreet     String?   @map("address_street")
  addressCity       String?   @map("address_city")
  addressState      String?   @map("address_state")
  addressZip        String?   @map("address_zip")
  bankName          String?   @map("bank_name")
  bankRoutingNumber String?   @map("bank_routing_number")
  bankAccountNumber String?   @map("bank_account_number")
  workState         String?   @map("work_state")
  employerName      String?   @map("employer_name")
  turbotaxEmail     String?   @map("turbotax_email")
  turbotaxPassword  String?   @map("turbotax_password")
  profileComplete   Boolean   @default(false) @map("profile_complete")
  isDraft           Boolean   @default(true) @map("is_draft")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  taxCases          TaxCase[]

  @@map("client_profiles")
}

model TaxCase {
  id                 String          @id @default(uuid()) @db.Uuid
  clientProfileId    String          @map("client_profile_id") @db.Uuid
  taxYear            Int             @map("tax_year")
  internalStatus     InternalStatus  @default(revision_de_registro) @map("internal_status")
  clientStatus       ClientStatus    @default(esperando_datos) @map("client_status")
  federalStatus      TaxStatus?      @map("federal_status")
  stateStatus        TaxStatus?      @map("state_status")
  estimatedRefund    Decimal?        @map("estimated_refund") @db.Decimal(10, 2)
  actualRefund       Decimal?        @map("actual_refund") @db.Decimal(10, 2)
  refundDepositDate  DateTime?       @map("refund_deposit_date")
  // Separate federal/state tracking
  federalEstimatedDate  DateTime?    @map("federal_estimated_date")
  stateEstimatedDate    DateTime?    @map("state_estimated_date")
  federalActualRefund   Decimal?     @map("federal_actual_refund") @db.Decimal(10, 2)
  stateActualRefund     Decimal?     @map("state_actual_refund") @db.Decimal(10, 2)
  federalDepositDate    DateTime?    @map("federal_deposit_date")
  stateDepositDate      DateTime?    @map("state_deposit_date")
  paymentReceived    Boolean         @default(false) @map("payment_received")
  commissionPaid     Boolean         @default(false) @map("commission_paid")
  // Year-specific employment and banking info
  workState          String?         @map("work_state")
  employerName       String?         @map("employer_name")
  bankName           String?         @map("bank_name")
  bankRoutingNumber  String?         @map("bank_routing_number")
  bankAccountNumber  String?         @map("bank_account_number")
  statusUpdatedAt    DateTime        @default(now()) @map("status_updated_at")
  // Admin step control (1-5)
  adminStep          Int?            @map("admin_step")
  // Problem tracking (hidden from client)
  hasProblem         Boolean         @default(false) @map("has_problem")
  problemStep        Int?            @map("problem_step")
  problemType        ProblemType?    @map("problem_type")
  problemDescription String?         @map("problem_description")
  problemResolvedAt  DateTime?       @map("problem_resolved_at")
  createdAt          DateTime        @default(now()) @map("created_at")
  updatedAt          DateTime        @updatedAt @map("updated_at")
  documents          Document[]
  statusHistory      StatusHistory[]
  clientProfile      ClientProfile   @relation(fields: [clientProfileId], references: [id], onDelete: Cascade)

  @@unique([clientProfileId, taxYear])
  @@map("tax_cases")
}

model Document {
  id          String       @id @default(uuid()) @db.Uuid
  taxCaseId   String       @map("tax_case_id") @db.Uuid
  type        DocumentType
  fileName    String       @map("file_name")
  storagePath String       @map("storage_path")
  mimeType    String       @map("mime_type")
  fileSize    Int          @map("file_size")
  taxYear     Int?         @map("tax_year")
  isReviewed  Boolean      @default(false) @map("is_reviewed")
  uploadedAt  DateTime     @default(now()) @map("uploaded_at")
  taxCase     TaxCase      @relation(fields: [taxCaseId], references: [id], onDelete: Cascade)

  @@map("documents")
}

model Ticket {
  id        String          @id @default(uuid()) @db.Uuid
  userId    String          @map("user_id") @db.Uuid
  subject   String
  status    TicketStatus    @default(open)
  createdAt DateTime        @default(now()) @map("created_at")
  updatedAt DateTime        @updatedAt @map("updated_at")
  messages  TicketMessage[]
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("tickets")
}

model TicketMessage {
  id        String   @id @default(uuid()) @db.Uuid
  ticketId  String   @map("ticket_id") @db.Uuid
  senderId  String?  @map("sender_id") @db.Uuid
  message   String
  createdAt DateTime @default(now()) @map("created_at")
  sender    User?    @relation(fields: [senderId], references: [id], onDelete: SetNull)
  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@map("ticket_messages")
}

model StatusHistory {
  id             String   @id @default(uuid()) @db.Uuid
  taxCaseId      String   @map("tax_case_id") @db.Uuid
  previousStatus String?  @map("previous_status")
  newStatus      String   @map("new_status")
  changedById    String?  @map("changed_by_id") @db.Uuid
  comment        String?
  createdAt      DateTime @default(now()) @map("created_at")
  changedBy      User?    @relation("ChangedBy", fields: [changedById], references: [id], onDelete: SetNull)
  taxCase        TaxCase  @relation(fields: [taxCaseId], references: [id], onDelete: Cascade)

  @@map("status_history")
}

model Notification {
  id        String           @id @default(uuid()) @db.Uuid
  userId    String           @map("user_id") @db.Uuid
  type      NotificationType
  title     String
  message   String
  isRead    Boolean          @default(false) @map("is_read")
  createdAt DateTime         @default(now()) @map("created_at")
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

enum UserRole {
  client
  admin
}

enum InternalStatus {
  revision_de_registro
  esperando_datos
  falta_documentacion
  en_proceso
  en_verificacion
  resolviendo_verificacion
  inconvenientes
  cheque_en_camino
  esperando_pago_comision
  proceso_finalizado
}

enum ClientStatus {
  esperando_datos
  cuenta_en_revision
  taxes_en_proceso
  taxes_en_camino
  taxes_depositados
  pago_realizado
  en_verificacion
  taxes_finalizados
}

enum TaxStatus {
  pending
  processing
  approved
  rejected
  deposited
}

enum DocumentType {
  w2
  payment_proof
  other
}

enum TicketStatus {
  open
  in_progress
  closed
}

enum NotificationType {
  status_change
  docs_missing
  message
  system
  problem_alert
}

enum ProblemType {
  missing_documents
  incorrect_information
  irs_verification
  bank_issue
  state_issue
  federal_issue
  client_unresponsive
  other
}

model W2Estimate {
  id              String         @id @default(uuid()) @db.Uuid
  userId          String         @map("user_id") @db.Uuid
  taxCaseId       String?        @map("tax_case_id") @db.Uuid
  box2Federal     Decimal        @map("box_2_federal") @db.Decimal(10, 2)
  box17State      Decimal        @map("box_17_state") @db.Decimal(10, 2)
  estimatedRefund Decimal        @map("estimated_refund") @db.Decimal(10, 2)
  w2FileName      String         @map("w2_file_name")
  w2StoragePath   String?        @map("w2_storage_path")
  ocrConfidence   OcrConfidence  @map("ocr_confidence")
  ocrRawResponse  Json?          @map("ocr_raw_response")
  createdAt       DateTime       @default(now()) @map("created_at")
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("w2_estimates")
}

enum OcrConfidence {
  high
  medium
  low
}
